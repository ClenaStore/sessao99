<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SESS√ÉO 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --text:#fff;
  --muted:#aaa;
  --accent:#e50914;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Inter,Arial,sans-serif;
  overflow:hidden;
}

/* HEADER */
header{
  position:fixed;top:0;left:0;right:0;height:72px;
  display:flex;align-items:center;gap:18px;
  padding:0 24px;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(10px);
  z-index:50;
}
.logo{font-size:22px;font-weight:800;color:var(--accent)}
.search{flex:1;max-width:520px}
.search input{
  width:100%;height:42px;border-radius:20px;
  border:1px solid #333;background:#111;color:#fff;padding:0 18px;
}
.profile{
  width:42px;height:42px;border-radius:50%;
  background:#222;border:none;color:#fff;font-size:18px;cursor:pointer;
}

/* NAV */
.nav{
  margin-top:72px;padding:14px 24px;
  display:flex;gap:26px;border-bottom:1px solid #222;
}
.nav button{
  background:none;border:none;color:#aaa;font-size:16px;cursor:pointer;
}
.nav button.active{color:#fff;font-weight:700}

/* FILTERS */
.filters{
  padding:12px 24px;display:flex;gap:10px;flex-wrap:wrap;
}
.filters button{
  padding:8px 16px;border-radius:20px;
  border:1px solid #333;background:#111;color:#fff;cursor:pointer;
}
.filters button.active{background:var(--accent);border-color:var(--accent)}

/* HOME */
#home{
  padding:20px 0 60px;
  overflow-y:auto;
  height:calc(100vh - 160px);
}
.section{margin-bottom:40px}
.section h2{margin:0 0 14px 24px}
.row{display:flex;gap:14px;padding:0 24px;overflow-x:auto}
.card{min-width:160px;cursor:pointer;transition:.25s}
.card:hover{transform:scale(1.08)}
.card img{
  width:100%;height:240px;object-fit:cover;border-radius:10px;
}

/* TOP 10 */
.top{position:relative}
.rank{
  position:absolute;bottom:-10px;left:-10px;
  font-size:64px;font-weight:900;color:#fff;
}

/* PLAYER */
#player{
  position:fixed;inset:0;background:#000;
  display:none;z-index:100;
}
#player video{width:100%;height:100%;object-fit:cover}
#homeBtn{
  position:absolute;top:20px;left:20px;
  background:rgba(0,0,0,.6);border:none;color:#fff;
  font-size:20px;padding:10px 14px;cursor:pointer;z-index:10;
}

/* OVERLAY */
#overlay{position:absolute;inset:0}
#overlay::before{
  content:"";position:absolute;inset:0;
  background:
    linear-gradient(to right,rgba(0,0,0,.85) 25%,transparent 60%),
    linear-gradient(to top,rgba(0,0,0,.9) 15%,transparent 50%);
}
#info{
  position:absolute;left:40px;bottom:120px;max-width:520px;
}
#info p{color:var(--muted)}
#info button{
  margin-top:16px;padding:12px 22px;
  border:none;font-weight:700;cursor:pointer;
}

/* SERIES */
.series-controls{
  display:none;gap:10px;margin-top:12px;
}
.series-controls select{
  padding:10px 18px;border-radius:20px;
  background:#111;color:#fff;border:1px solid #333;
}

/* PERFIL MODAL */
#perfilModal{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  backdrop-filter:blur(8px);display:none;
  align-items:center;justify-content:center;z-index:200;
}
#perfilBox{
  width:420px;background:#111;border-radius:18px;
  padding:26px;position:relative;
}
#perfilClose{
  position:absolute;top:12px;right:14px;cursor:pointer;
}
</style>
</head>

<body>

<header>
  <div class="logo">SESS√ÉO 99</div>
  <div class="search"><input id="search" placeholder="Buscar..."></div>
  <button class="profile" onclick="abrirPerfil()">üë§</button>
</header>

<div class="nav">
  <button class="active" onclick="setTipo('all',this)">Para voc√™</button>
  <button onclick="setTipo('filme',this)">Filmes</button>
  <button onclick="setTipo('serie',this)">S√©ries</button>
</div>

<div class="filters" id="filters"></div>
<div id="home"></div>

<!-- PLAYER -->
<div id="player">
  <video id="video" playsinline></video>
  <button id="homeBtn" onclick="fecharPlayer()">üè†</button>

  <div id="overlay">
    <div id="info">
      <h1 id="titulo"></h1>
      <p id="descricao"></p>

      <div class="series-controls" id="seriesControls">
        <select id="selTemporada"></select>
        <select id="selEpisodio"></select>
      </div>

      <button onclick="assistir()">‚ñ∂ Assistir</button>
    </div>
  </div>
</div>

<!-- PERFIL -->
<div id="perfilModal">
  <div id="perfilBox">
    <div id="perfilClose" onclick="fecharPerfil()">‚úï</div>
    <h2>Meu Perfil</h2>
    <div id="p_email"></div>
    <div id="p_status"></div>
    <div style="text-align:right">
      <button onclick="logout()" style="color:#ff6b6b;background:none;border:none">Sair</button>
    </div>
  </div>
</div>

<script>
/* ============ SUPABASE ============ */
const sb = supabase.createClient(
 "https://dxkszikemntfusfyrzos.supabase.co",
 "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

if(!localStorage.usuario) location.href="login.html";

const video=document.getElementById("video");
const home=document.getElementById("home");
const filtersBox=document.getElementById("filters");
const search=document.getElementById("search");

let dados=[], atual=null, serieAtual=[], indiceEp=0;
let filtroGenero="Todos", filtroTipo="all";
let hideTimer=null, hls=null, audioUnlocked=false;

/* PERFIL */
function abrirPerfil(){
  const u=JSON.parse(localStorage.usuario);
  p_email.textContent="Email: "+u.email;
  p_status.textContent="Status: "+(u.status||"ativo");
  perfilModal.style.display="flex";
}
function fecharPerfil(){perfilModal.style.display="none"}
function logout(){
  localStorage.removeItem("usuario");
  location.href="login.html";
}

/* NAV */
function setTipo(t,b){
  filtroTipo=t;
  document.querySelectorAll(".nav button").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  renderHome();
}

/* LOAD */
async function load(){
  const {data}=await sb.from("filmes").select("*").eq("ativo",true);
  dados=data||[];
  montarFiltros();
  renderHome();
}

/* FILTROS */
function montarFiltros(){
  const g=[...new Set(dados.map(d=>d.genero).filter(Boolean))];
  filtersBox.innerHTML="";
  ["Todos",...g].forEach(x=>{
    const b=document.createElement("button");
    b.textContent=x;
    b.className=x===filtroGenero?"active":"";
    b.onclick=()=>{filtroGenero=x;montarFiltros();renderHome()};
    filtersBox.appendChild(b);
  });
}

/* HOME */
function renderHome(){
  home.innerHTML="";
  const termo=search.value.toLowerCase();

  const filtrados=dados.filter(d=>{
    if(filtroTipo!=="all"&&d.tipo!==filtroTipo) return false;
    if(filtroGenero!=="Todos"&&d.genero!==filtroGenero) return false;
    return (d.titulo||d.serie_nome||"").toLowerCase().includes(termo);
  });

  sec("Filmes",filtrados.filter(d=>d.tipo==="filme"));
  sec("S√©ries",[...new Map(filtrados.filter(d=>d.tipo==="serie").map(s=>[s.serie_nome,s])).values()]);
}

function sec(t,it){
  if(!it.length) return;
  const s=document.createElement("div");
  s.className="section";
  s.innerHTML=`<h2>${t}</h2>`;
  const r=document.createElement("div");
  r.className="row";
  it.forEach(i=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<img src="${i.capa_url}">`;
    c.onclick=()=>abrir(i);
    r.appendChild(c);
  });
  s.appendChild(r);
  home.appendChild(s);
}

/* PLAYER */
function abrir(i){
  atual=i;
  player.style.display="block";
  titulo.textContent=i.titulo||i.serie_nome;
  descricao.textContent=i.descricao||"";

  if(i.tipo==="serie"){montarSerie(i.serie_nome);seriesControls.style.display="flex"}
  else seriesControls.style.display="none";

  carregarVideo(i.video_url);
  iniciarTimer();
}

function carregarVideo(url){
  if(hls){hls.destroy();hls=null}
  if(url.endsWith(".m3u8")&&Hls.isSupported()){
    hls=new Hls();hls.loadSource(url);hls.attachMedia(video);
  }else video.src=url;
  video.muted=!audioUnlocked;
  video.play();
}

function assistir(){
  audioUnlocked=true;
  video.muted=false;
  video.play();
  document.body.classList.add("hide-ui");
}

/* SERIES */
function montarSerie(nome){
  serieAtual=dados.filter(d=>d.serie_nome===nome).sort((a,b)=>a.temporada-b.temporada||a.episodio-b.episodio);
  selTemporada.innerHTML="";
  [...new Set(serieAtual.map(e=>e.temporada))].forEach(t=>selTemporada.innerHTML+=`<option>${t}</option>`);
  selTemporada.onchange=montarEpisodios;
  montarEpisodios();
}
function montarEpisodios(){
  const eps=serieAtual.filter(e=>e.temporada==selTemporada.value);
  selEpisodio.innerHTML="";
  eps.forEach((e,i)=>selEpisodio.innerHTML+=`<option value="${i}">${e.episodio}</option>`);
  selEpisodio.onchange=()=>trocarEpisodio(eps,selEpisodio.value);
  trocarEpisodio(eps,0);
}
function trocarEpisodio(eps,i){
  indiceEp=i;atual=eps[i];carregarVideo(atual.video_url);
}

/* TIMER */
function iniciarTimer(){
  clearTimeout(hideTimer);
  hideTimer=setTimeout(()=>document.body.classList.add("hide-ui"),30000);
}
video.addEventListener("pause",()=>document.body.classList.remove("hide-ui"));
video.addEventListener("play",iniciarTimer);

/* FECHAR */
function fecharPlayer(){
  if(hls){hls.destroy();hls=null}
  video.pause();video.src="";
  player.style.display="none";
}

/* CONTROLE */
document.addEventListener("keydown",e=>{
  if(player.style.display!=="block")return;
  if(e.key==="Enter")video.paused?video.play():video.pause();
  if(e.key==="ArrowLeft")video.currentTime-=10;
  if(e.key==="ArrowRight")video.currentTime+=10;
  if(e.key==="Escape")fecharPlayer();
});

search.oninput=renderHome;
load();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Login | Sessão 99</title>

<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
html,body{
  margin:0;
  height:100%;
  background:#0f0f10;
  color:#fff;
  overflow:hidden;
  touch-action:manipulation;
}
input,button{
  font-size:16px;
  touch-action:manipulation;
}

/* FUNDO */
video{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:-2;
}
.bg{
  position:fixed;
  inset:0;
  background:
    linear-gradient(to right,
      rgba(0,0,0,.88) 0%,
      rgba(0,0,0,.75) 40%,
      rgba(0,0,0,.45) 60%,
      rgba(0,0,0,.15) 75%,
      rgba(0,0,0,0) 90%),
    linear-gradient(to top,
      rgba(0,0,0,.65) 0%,
      rgba(0,0,0,.35) 35%,
      rgba(0,0,0,0) 65%);
  z-index:-1;
}

/* LOGIN */
.container{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:420px;
  max-width:92%;
  background:rgba(27,27,30,.75);
  backdrop-filter:blur(14px);
  padding:42px;
  border-radius:18px;
}

h1{margin-bottom:28px;font-size:38px;font-weight:800}
h1 span{color:#e50914}

.group{margin-bottom:18px}
label{font-size:14px;color:#b5b5b5}
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #2b2b2b;
  background:rgba(0,0,0,.45);
  color:#fff;
}

.btn{
  width:100%;
  padding:15px;
  border:none;
  border-radius:14px;
  background:#e50914;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
.btn.loading{pointer-events:none;opacity:.8}

.link{
  margin-top:18px;
  text-align:center;
  font-size:14px;
  cursor:pointer;
  text-decoration:underline;
}

.msg{
  margin-top:16px;
  min-height:40px;
  font-size:14px;
  color:#facc15;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.modal-box{
  width:420px;
  max-width:92%;
  background:#1b1b1e;
  padding:34px;
  border-radius:18px;
}

/* OVERLAY BLOQUEADO */
#overlay{
  position:fixed;
  inset:0;
  background:#0f0f10;
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  z-index:999;
}
#overlay h2{color:#e50914}
#overlay a{
  display:inline-block;
  margin-top:16px;
  padding:14px 26px;
  border-radius:999px;
  background:#25d366;
  color:#000;
  font-weight:700;
  text-decoration:none;
}
</style>
</head>

<body>

<video autoplay muted loop playsinline>
  <source src="SEU_VIDEO.mp4">
</video>
<div class="bg"></div>

<!-- LOGIN -->
<div class="container">
  <h1>Sessão <span>99</span></h1>

  <div class="group">
    <label>Email</label>
    <input id="email" type="email" autocomplete="username">
  </div>

  <div class="group">
    <label>Senha</label>
    <input id="senha" type="password" autocomplete="current-password">
  </div>

  <button class="btn" id="btnLogin" type="button">Entrar</button>

  <div class="link" onclick="modal.style.display='flex'">
    Ainda não tenho uma conta
  </div>

  <div class="msg" id="msg"></div>
</div>

<!-- CADASTRO -->
<div class="modal" id="modal" onclick="if(event.target===this)this.style.display='none'">
  <div class="modal-box">
    <h2>Criar conta</h2>

    <div class="group">
      <label>Email</label>
      <input id="c_email" type="email">
    </div>

    <div class="group">
      <label>CPF</label>
      <input id="c_cpf" inputmode="numeric" placeholder="000.000.000-00">
    </div>

    <div class="group">
      <label>WhatsApp</label>
      <input id="c_whats" inputmode="numeric" placeholder="(00) 00000-0000">
    </div>

    <div class="group">
      <label>Senha</label>
      <input id="c_senha" type="password">
    </div>

    <div class="group">
      <label>Confirmar senha</label>
      <input id="c_confirma" type="password">
    </div>

    <button class="btn" id="btnCadastro" type="button">Cadastrar</button>
    <div class="link" onclick="modal.style.display='none'">Cancelar</div>
  </div>
</div>

<!-- OVERLAY BLOQUEADO -->
<div id="overlay">
  <div>
    <h2>Acesso bloqueado</h2>
    <p>Entre em contato para regularizar</p>
    <a id="waLink" target="_blank">Falar no WhatsApp</a>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ================= MASKS ================= */
function maskCPF(v){
  v=v.replace(/\D/g,"").slice(0,11);
  return v.replace(/(\d{3})(\d)/,"$1.$2")
          .replace(/(\d{3})(\d)/,"$1.$2")
          .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function maskPhone(v){
  v=v.replace(/\D/g,"").slice(0,11);
  return v.replace(/^(\d{2})(\d)/,"($1) $2")
          .replace(/(\d{5})(\d{4})$/,"$1-$2");
}
c_cpf.oninput=()=>c_cpf.value=maskCPF(c_cpf.value);
c_whats.oninput=()=>c_whats.value=maskPhone(c_whats.value);

/* CPF VALID */
function cpfValido(cpf){
  cpf=cpf.replace(/\D/g,"");
  if(cpf.length!==11||/^(\d)\1+$/.test(cpf))return false;
  let s=0;
  for(let i=0;i<9;i++)s+=cpf[i]*(10-i);
  let d=11-(s%11);if(d>9)d=0;
  if(d!=cpf[9])return false;
  s=0;
  for(let i=0;i<10;i++)s+=cpf[i]*(11-i);
  d=11-(s%11);if(d>9)d=0;
  return d==cpf[10];
}

/* LOGIN */
btnLogin.onclick=async()=>{
  msg.textContent="";
  btnLogin.classList.add("loading");

  const {data}=await sb
    .from("usuarios")
    .select("*")
    .eq("email",email.value.trim())
    .single();

  btnLogin.classList.remove("loading");

  if(!data||data.senha!==senha.value){
    msg.textContent="Usuário ou senha inválidos";
    return;
  }

  if(data.status==="bloqueado"){
    overlay.style.display="flex";
    waLink.href=`https://wa.me/55${data.whatsapp||""}`;
    return;
  }

  localStorage.setItem("usuario_email",data.email);
  location.href="index.html";
};

/* CADASTRO */
btnCadastro.onclick=async()=>{
  if(!cpfValido(c_cpf.value)){
    alert("CPF inválido");
    return;
  }
  if(c_senha.value!==c_confirma.value||c_senha.value.length<4){
    alert("Senha inválida");
    return;
  }

  await sb.from("usuarios").insert({
    email:c_email.value.trim(),
    cpf:c_cpf.value.replace(/\D/g,""),
    whatsapp:c_whats.value.replace(/\D/g,""),
    senha:c_senha.value,
    status:"pendente",
    trial_expires_at:new Date(Date.now()+86400000).toISOString()
  });

  alert("Cadastro criado. Aguarde ativação.");
  modal.style.display="none";
};
</script>

</body>
</html>

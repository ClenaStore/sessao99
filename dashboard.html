<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üìä Monitoramento ‚Ä¢ SESS√ÉO 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#05070f;
  --panel:#0f1424;
  --card:#151a30;
  --accent:#e50914;
  --text:#fff;
  --muted:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,Arial,sans-serif;
}
header{
  padding:20px 32px;
  background:#000;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h1{margin:0;color:var(--accent)}
header span{color:#22c55e}

main{
  padding:24px 32px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
}

/* CARDS */
.card{
  background:var(--panel);
  padding:18px;
  border-radius:14px;
}
.card h3{
  margin:0 0 8px;
  font-size:14px;
  color:var(--muted);
}
.card strong{font-size:28px}

/* GR√ÅFICOS */
.chart{
  background:var(--panel);
  padding:18px;
  border-radius:14px;
}
.chart canvas{height:280px!important}

/* TABELAS */
.table{
  background:var(--panel);
  padding:18px;
  border-radius:14px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #222;
}
th{color:var(--muted);text-align:left}

/* FULL */
.full{grid-column:1/-1}
</style>
</head>
<body>

<header>
  <h1>üìä Monitoramento</h1>
  <span>‚óè Online</span>
</header>

<main>

  <!-- KPIs -->
  <div class="card"><h3>Usu√°rios Online</h3><strong id="kpiOnline">0</strong></div>
  <div class="card"><h3>Plays Hoje</h3><strong id="kpiPlays">0</strong></div>
  <div class="card"><h3>Filmes</h3><strong id="kpiFilmes">0</strong></div>
  <div class="card"><h3>S√©ries</h3><strong id="kpiSeries">0</strong></div>

  <!-- GR√ÅFICOS -->
  <div class="chart full"><canvas id="chartOnline"></canvas></div>
  <div class="chart"><canvas id="chartTipo"></canvas></div>
  <div class="chart"><canvas id="chartTop"></canvas></div>

  <!-- QUEM EST√Å ASSISTINDO -->
  <div class="table full">
    <h3>üë• Quem est√° assistindo agora</h3>
    <table>
      <thead>
        <tr>
          <th>Usu√°rio</th>
          <th>Conte√∫do</th>
          <th>Tipo</th>
          <th>Localiza√ß√£o</th>
          <th>√öltimo ping</th>
        </tr>
      </thead>
      <tbody id="tableOnline"></tbody>
    </table>
  </div>

</main>

<script>
/* SUPABASE */
const supabaseClient = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const kpiOnline=document.getElementById("kpiOnline");
const kpiPlays=document.getElementById("kpiPlays");
const kpiFilmes=document.getElementById("kpiFilmes");
const kpiSeries=document.getElementById("kpiSeries");
const tableOnline=document.getElementById("tableOnline");

let chartOnline,chartTipo,chartTop;

/* LOAD */
async function load(){
  const agora = new Date(Date.now()-30000).toISOString();

  const [{data:sessions},{data:plays},{data:filmes}] = await Promise.all([
    supabaseClient.from("rs_sessions").select("*").gte("last_ping",agora),
    supabaseClient.from("rs_play_events").select("*"),
    supabaseClient.from("filmes").select("*")
  ]);

  kpiOnline.textContent=sessions.length;
  kpiPlays.textContent=plays.filter(p=>p.acao==="play").length;
  kpiFilmes.textContent=filmes.filter(f=>f.tipo==="filme").length;
  kpiSeries.textContent=[...new Set(filmes.filter(f=>f.tipo==="serie").map(f=>f.serie_nome))].length;

  renderOnline(sessions,plays);
  graficoOnline(sessions);
  graficoTipo(plays);
  graficoTop(plays);
}

function renderOnline(sessions,plays){
  tableOnline.innerHTML="";
  sessions.forEach(s=>{
    const lastPlay=plays.filter(p=>p.user_id===s.user_id).slice(-1)[0];
    if(!lastPlay) return;

    tableOnline.innerHTML+=`
      <tr>
        <td>${s.user_id.slice(0,8)}</td>
        <td>${lastPlay.titulo}</td>
        <td>${lastPlay.tipo}</td>
        <td>${s.city||"-"} / ${s.country||"-"}</td>
        <td>${new Date(s.last_ping).toLocaleTimeString()}</td>
      </tr>`;
  });
}

/* GR√ÅFICOS */
function graficoOnline(list){
  if(chartOnline) chartOnline.destroy();
  chartOnline=new Chart(document.getElementById("chartOnline"),{
    type:"line",
    data:{labels:["Agora"],datasets:[{label:"Usu√°rios Online",data:[list.length],borderColor:"#e50914"}]}
  });
}

function graficoTipo(list){
  const f=list.filter(p=>p.tipo==="filme").length;
  const s=list.filter(p=>p.tipo==="serie").length;

  if(chartTipo) chartTipo.destroy();
  chartTipo=new Chart(document.getElementById("chartTipo"),{
    type:"pie",
    data:{labels:["Filmes","S√©ries"],datasets:[{data:[f,s],backgroundColor:["#e50914","#6366f1"]}]}
  });
}

function graficoTop(list){
  const map={};
  list.filter(p=>p.acao==="play").forEach(p=>{
    map[p.titulo]=(map[p.titulo]||0)+1;
  });

  const labels=Object.keys(map).slice(0,10);
  const data=Object.values(map).slice(0,10);

  if(chartTop) chartTop.destroy();
  chartTop=new Chart(document.getElementById("chartTop"),{
    type:"bar",
    data:{labels,datasets:[{data,backgroundColor:"#22c55e"}]}
  });
}

load();
setInterval(load,15000);
</script>

</body>
</html>

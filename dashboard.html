<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard 窶｢ SESSﾃグ 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#05070f;
  --panel:#0b1020;
  --card:#141a2e;
  --accent:#e50914;
  --text:#fff;
  --muted:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,Arial,sans-serif;
}
header{
  padding:18px 32px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#000;
}
header h1{color:var(--accent);margin:0}

main{
  padding:24px 32px;
  display:grid;
  gap:20px;
}

/* FILTER */
.filter{
  display:flex;
  gap:12px;
  align-items:center;
}
input[type="date"]{
  background:#111;
  border:none;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
}

/* KPIs */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.kpi{
  background:var(--panel);
  padding:18px;
  border-radius:14px;
}
.kpi span{color:var(--muted);font-size:13px}
.kpi strong{font-size:30px}

/* PANELS */
.panel{
  background:var(--panel);
  padding:18px;
  border-radius:14px;
}
.panel h2{
  margin:0 0 12px;
  font-size:16px;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  text-align:left;
  border-bottom:1px solid #1f243d;
}
th{color:var(--muted);font-weight:500}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}
canvas{height:260px!important}
</style>
</head>

<body>

<header>
  <h1>沒 Dashboard 窶｢ SESSﾃグ 99</h1>
  <div class="filter">
    <span>沒 Data:</span>
    <input type="date" id="filterDate">
  </div>
</header>

<main>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi"><span>汨･ Assistindo agora</span><strong id="kpiOnline">0</strong></div>
    <div class="kpi"><span>笆ｶ Plays no dia</span><strong id="kpiPlays">0</strong></div>
    <div class="kpi"><span>笨 +50% assistido</span><strong id="kpi50">0</strong></div>
    <div class="kpi"><span>沛 Concluﾃｭdos</span><strong id="kpiFinish">0</strong></div>
  </div>

  <!-- ONLINE -->
  <div class="panel">
    <h2>汨 Quem estﾃ｡ assistindo agora</h2>
    <table>
      <thead>
        <tr>
          <th>Usuﾃ｡rio</th>
          <th>Conteﾃｺdo</th>
          <th>Tipo</th>
        </tr>
      </thead>
      <tbody id="onlineList"></tbody>
    </table>
  </div>

  <!-- GRﾃ：ICOS -->
  <div class="grid">
    <div class="panel">
      <h2>沒 Plays por hora</h2>
      <canvas id="chartHoras"></canvas>
    </div>
    <div class="panel">
      <h2>沁ｬ Filmes x Sﾃｩries</h2>
      <canvas id="chartTipos"></canvas>
    </div>
  </div>

  <!-- TOP -->
  <div class="panel">
    <h2>沛 Top 10 Conteﾃｺdos</h2>
    <table>
      <thead>
        <tr>
          <th>Conteﾃｺdo</th>
          <th>Plays</th>
        </tr>
      </thead>
      <tbody id="topList"></tbody>
    </table>
  </div>

</main>

<script>
const supabaseClient = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const kpiOnline = document.getElementById("kpiOnline");
const kpiPlays = document.getElementById("kpiPlays");
const kpi50 = document.getElementById("kpi50");
const kpiFinish = document.getElementById("kpiFinish");
const onlineList = document.getElementById("onlineList");
const topList = document.getElementById("topList");
const filterDate = document.getElementById("filterDate");

let chartHoras, chartTipos;

/* DATA PADRﾃグ = HOJE */
filterDate.value = new Date().toISOString().slice(0,10);

async function loadDashboard(){
  const selectedDate = filterDate.value;

  /* ONLINE (SEM DUPLICAR USER) */
  const { data: online } = await supabaseClient
    .from("rs_sessions")
    .select("user_id, content_tipo, serie_nome")
    .gte("last_ping", new Date(Date.now()-30000).toISOString());

  const uniqueUsers = {};
  online.forEach(o=>{
    uniqueUsers[o.user_id]=o;
  });

  const onlineArr = Object.values(uniqueUsers);
  kpiOnline.textContent = onlineArr.length;

  onlineList.innerHTML="";
  onlineArr.forEach(u=>{
    onlineList.innerHTML+=`
      <tr>
        <td>${u.user_id.slice(0,8)}</td>
        <td>${u.serie_nome || "-"}</td>
        <td>${u.content_tipo}</td>
      </tr>`;
  });

  /* EVENTS DO DIA */
  const { data: events } = await supabaseClient
    .from("rs_play_events")
    .select("*")
    .gte("created_at", selectedDate+"T00:00:00")
    .lte("created_at", selectedDate+"T23:59:59");

  kpiPlays.textContent = events.filter(e=>e.acao==="play").length;

  /* PROGRESSO */
  const { data: progress } = await supabaseClient
    .from("rs_user_progress")
    .select("*");

  kpi50.textContent = progress.filter(p=>p.max_progress>=50).length;
  kpiFinish.textContent = progress.filter(p=>p.max_progress>=95).length;

  /* TOP 10 */
  const map = {};
  events.forEach(e=>{
    if(e.acao==="play"){
      map[e.titulo]=(map[e.titulo]||0)+1;
    }
  });

  topList.innerHTML="";
  Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10)
    .forEach(([t,c])=>{
      topList.innerHTML+=`<tr><td>${t}</td><td>${c}</td></tr>`;
    });

  /* GRﾃ：ICO HORAS */
  const horas={};
  events.forEach(e=>{
    const h=new Date(e.created_at).getHours();
    horas[h]=(horas[h]||0)+1;
  });

  if(chartHoras) chartHoras.destroy();
  chartHoras=new Chart(document.getElementById("chartHoras"),{
    type:"line",
    data:{
      labels:Object.keys(horas),
      datasets:[{data:Object.values(horas),borderColor:"#e50914"}]
    }
  });

  /* TIPOS */
  const filmes=events.filter(e=>e.tipo==="filme").length;
  const series=events.filter(e=>e.tipo==="serie").length;

  if(chartTipos) chartTipos.destroy();
  chartTipos=new Chart(document.getElementById("chartTipos"),{
    type:"doughnut",
    data:{
      labels:["Filmes","Sﾃｩries"],
      datasets:[{data:[filmes,series],backgroundColor:["#e50914","#6366f1"]}]
    }
  });
}

filterDate.onchange = loadDashboard;
loadDashboard();
setInterval(loadDashboard,15000);
</script>

</body>
</html>

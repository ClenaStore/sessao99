<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard â€¢ SessÃ£o 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f0f10;
  --card:#1b1b1e;
  --accent:#e50914;
  --text:#fff;
  --muted:#aaa;
}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:20px 32px;
  background:#000;
  position:sticky;
  top:0;
}
header h1{margin:0;color:var(--accent)}

main{
  padding:32px;
  display:grid;
  gap:32px;
}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}
.kpi{
  background:var(--card);
  padding:20px;
  border-radius:14px;
}
.kpi span{color:var(--muted);font-size:13px}
.kpi strong{font-size:34px;display:block;margin-top:6px}

.section h2{margin:0 0 14px;font-size:20px}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:18px;
}

.card{
  background:var(--card);
  border-radius:14px;
  overflow:hidden;
}
.card img{
  width:100%;
  height:260px;
  object-fit:cover;
}
.card-info{
  padding:12px;
}
.card-info strong{display:block}
.card-info span{font-size:12px;color:var(--muted)}

footer{
  text-align:right;
  font-size:12px;
  color:var(--muted);
}

canvas{
  background:var(--card);
  border-radius:14px;
  padding:10px;
}
</style>
</head>

<body>

<header>
  <h1>ğŸ“Š Dashboard â€¢ SessÃ£o 99</h1>
</header>

<main>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi">
    <span>ğŸ‘€ Online agora</span>
    <strong id="kpiOnline">0</strong>
  </div>
  <div class="kpi">
    <span>â–¶ VisualizaÃ§Ãµes hoje</span>
    <strong id="kpiHoje">0</strong>
  </div>
  <div class="kpi">
    <span>ğŸ“… VisualizaÃ§Ãµes semana</span>
    <strong id="kpiSemana">0</strong>
  </div>
</div>

<!-- TOP AGORA -->
<div class="section">
  <h2>ğŸ”¥ Top 10 assistindo agora</h2>
  <div class="grid" id="topAgora"></div>
</div>

<!-- TOP DIA -->
<div class="section">
  <h2>ğŸ† Top do dia</h2>
  <div class="grid" id="topDia"></div>
</div>

<!-- TOP SEMANA -->
<div class="section">
  <h2>ğŸ“… Top da semana</h2>
  <div class="grid" id="topSemana"></div>
</div>

<!-- GRÃFICOS -->
<div class="section">
  <h2>ğŸ“Š Categorias mais assistidas</h2>
  <canvas id="chartCategorias"></canvas>
</div>

<div class="section">
  <h2>ğŸ­ GÃªneros mais assistidos</h2>
  <canvas id="chartGeneros"></canvas>
</div>

<footer>
  Ãšltima atualizaÃ§Ã£o: <span id="lastUpdate">--</span>
</footer>

</main>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

let chartCat, chartGen;

async function loadDashboard(){
  const now = new Date();
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const semana = new Date(); semana.setDate(semana.getDate()-7);

  document.getElementById("lastUpdate").textContent =
    new Date().toLocaleString();

  /* ONLINE AGORA */
  const { data: online } = await sb
    .from("assistindo_agora")
    .select("usuario_id, filme_id, last_ping")
    .gte("last_ping", new Date(Date.now()-30000).toISOString());

  document.getElementById("kpiOnline").textContent = online.length;

  /* FILMES */
  const { data: filmes } = await sb.from("filmes").select("*");

  /* TOP AGORA (assistindo_agora) */
  const mapAgora = {};
  online.forEach(o=>{
    mapAgora[o.filme_id]=(mapAgora[o.filme_id]||0)+1;
  });

  renderTop(
    "topAgora",
    mapAgora,
    filmes,
    "ğŸ‘€ assistindo agora"
  );

  /* VISUALIZAÃ‡Ã•ES */
  const { data: vis } = await sb
    .from("visualizacoes")
    .select("filme_id, created_at");

  document.getElementById("kpiHoje").textContent =
    vis.filter(v=>new Date(v.created_at)>=hoje).length;

  document.getElementById("kpiSemana").textContent =
    vis.filter(v=>new Date(v.created_at)>=semana).length;

  renderTop(
    "topDia",
    countBy(vis.filter(v=>new Date(v.created_at)>=hoje)),
    filmes,
    "ğŸ‘ hoje"
  );

  renderTop(
    "topSemana",
    countBy(vis.filter(v=>new Date(v.created_at)>=semana)),
    filmes,
    "ğŸ‘ semana"
  );

  renderCharts(vis, filmes);
}

function countBy(list){
  const map={};
  list.forEach(v=>map[v.filme_id]=(map[v.filme_id]||0)+1);
  return map;
}

function renderTop(containerId, map, filmes, label){
  const container = document.getElementById(containerId);
  container.innerHTML="";
  Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10)
    .forEach(([id,total])=>{
      const f = filmes.find(x=>x.id===id);
      if(!f) return;
      container.innerHTML+=`
        <div class="card">
          <img src="${f.capa_url}">
          <div class="card-info">
            <strong>${f.titulo}</strong>
            <span>${f.categoria}</span>
            <div>${label}: ${total}</div>
          </div>
        </div>`;
    });
}

function renderCharts(vis, filmes){
  const cat={}, gen={};

  vis.forEach(v=>{
    const f = filmes.find(x=>x.id===v.filme_id);
    if(!f) return;
    if(f.categoria) cat[f.categoria]=(cat[f.categoria]||0)+1;
    if(f.genero) gen[f.genero]=(gen[f.genero]||0)+1;
  });

  if(chartCat) chartCat.destroy();
  if(chartGen) chartGen.destroy();

  chartCat = new Chart(chartCategorias,{
    type:"bar",
    data:{labels:Object.keys(cat),datasets:[{data:Object.values(cat),backgroundColor:"#e50914"}]},
    options:{plugins:{legend:{display:false}}}
  });

  chartGen = new Chart(chartGeneros,{
    type:"doughnut",
    data:{labels:Object.keys(gen),datasets:[{data:Object.values(gen)}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

/* REALTIME */
sb.channel("dashboard-realtime")
  .on("postgres_changes",{event:"*",schema:"public",table:"assistindo_agora"},loadDashboard)
  .on("postgres_changes",{event:"*",schema:"public",table:"visualizacoes"},loadDashboard)
  .subscribe();

loadDashboard();
</script>

</body>
</html>

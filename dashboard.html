<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard â€¢ SESSÃƒO 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#05070f;
  --panel:#0b1020;
  --card:#141a2e;
  --accent:#e50914;
  --text:#fff;
  --muted:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 50% -200px, #11183a, transparent),
    var(--bg);
  color:var(--text);
  font-family:Inter,Arial,sans-serif;
}

header{
  padding:18px 32px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(0,0,0,.8);
  backdrop-filter:blur(10px);
  position:sticky;
  top:0;
  z-index:10;
}
header h1{color:var(--accent);margin:0}

main{padding:24px 32px;display:grid;gap:22px}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.kpi{
  background:linear-gradient(180deg,#0f1533,#090d1f);
  padding:18px;
  border-radius:16px;
}
.kpi span{color:var(--muted);font-size:13px}
.kpi strong{font-size:30px}

.panel{
  background:linear-gradient(180deg,#0f1533,#090d1f);
  padding:18px;
  border-radius:16px;
}
.panel h2{margin:0 0 14px;font-size:16px}

table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1f243d}
th{color:var(--muted);text-align:left}

.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}

canvas{height:260px!important}

/* TOP CARD */
.top-card{
  display:flex;
  gap:14px;
  align-items:center;
  padding:12px;
  border-radius:14px;
  background:#0c122b;
  margin-bottom:10px;
}
.top-card img{
  width:80px;
  height:120px;
  object-fit:cover;
  border-radius:10px;
}
.top-info{
  flex:1;
}
.top-info strong{
  display:block;
  font-size:15px;
}
.top-info span{
  display:block;
  font-size:12px;
  color:var(--muted);
}
.progress{
  margin-top:6px;
  font-size:12px;
}

.filter{
  display:flex;
  gap:10px;
  align-items:center;
}
input[type=date]{
  background:#111;
  border:none;
  color:#fff;
  padding:8px 12px;
  border-radius:999px;
}
</style>
</head>

<body>

<header>
  <h1>ğŸ“Š Dashboard â€¢ SESSÃƒO 99</h1>
  <div class="filter">
    <span>ğŸ“… Data:</span>
    <input type="date" id="dataFiltro">
  </div>
</header>

<main>

<div class="kpis">
  <div class="kpi"><span>ğŸ‘¥ Assistindo agora</span><strong id="kpiOnline">0</strong></div>
  <div class="kpi"><span>â–¶ Plays no dia</span><strong id="kpiPlays">0</strong></div>
  <div class="kpi"><span>âœ… +50%</span><strong id="kpi50">0</strong></div>
  <div class="kpi"><span>ğŸ ConcluÃ­dos</span><strong id="kpiFinish">0</strong></div>
</div>

<div class="panel">
  <h2>ğŸ‘€ Quem estÃ¡ assistindo agora</h2>
  <table>
    <thead>
      <tr>
        <th>UsuÃ¡rio</th>
        <th>ConteÃºdo</th>
        <th>Tipo</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="onlineList"></tbody>
  </table>
</div>

<div class="grid">
  <div class="panel">
    <h2>ğŸ“ˆ Plays por hora</h2>
    <canvas id="chartHoras"></canvas>
  </div>
  <div class="panel">
    <h2>ğŸ¬ Filmes x SÃ©ries</h2>
    <canvas id="chartTipos"></canvas>
  </div>
</div>

<div class="panel">
  <h2>ğŸ”¥ Top 10 do Momento (30 min)</h2>
  <div id="topAgora"></div>
</div>

<div class="panel">
  <h2>ğŸ† Top 10 do Dia</h2>
  <div id="topDia"></div>
</div>

</main>

<script>
const supabaseClient = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* DATA LOCAL BR */
const hojeBR = new Date(new Date().getTime() - new Date().getTimezoneOffset()*60000)
  .toISOString().slice(0,10);

const dataFiltro = document.getElementById("dataFiltro");
dataFiltro.value = hojeBR;

let chartHoras, chartTipos;

async function loadDashboard(){
  const data = dataFiltro.value;

  /* ONLINE */
  const { data: online } = await supabaseClient
    .from("rs_sessions")
    .select("*")
    .gte("last_ping", new Date(Date.now()-30000).toISOString());

  kpiOnline.textContent = online.length;
  onlineList.innerHTML = "";
  online.forEach(u=>{
    onlineList.innerHTML += `
      <tr>
        <td>${u.user_id.slice(0,8)}</td>
        <td>${u.serie_nome || "-"}</td>
        <td>${u.content_tipo}</td>
        <td>playing</td>
      </tr>`;
  });

  /* EVENTS */
  const { data: events } = await supabaseClient
    .from("rs_play_events")
    .select("*")
    .gte("created_at", data+"T00:00:00")
    .lte("created_at", data+"T23:59:59");

  kpiPlays.textContent = events.filter(e=>e.acao==="play").length;
  kpi50.textContent = new Set(events.filter(e=>e.progress_percent>=50).map(e=>e.user_id)).size;
  kpiFinish.textContent = new Set(events.filter(e=>e.progress_percent>=95).map(e=>e.user_id)).size;

  /* FILMES (CAPAS) */
  const { data: filmes } = await supabaseClient.from("filmes").select("*");

  function renderTop(container, map){
    container.innerHTML="";
    Object.entries(map).slice(0,10).forEach(([titulo,info])=>{
      const filme = filmes.find(f=>f.titulo===titulo || f.serie_nome===titulo);
      container.innerHTML += `
        <div class="top-card">
          <img src="${filme?.capa_url || ''}">
          <div class="top-info">
            <strong>${titulo}</strong>
            <span>ğŸ‘ ${info.total} visualizaÃ§Ãµes</span>
            <div class="progress">âœ… ${info.finish}% | â–¶ ${info.mid}%</div>
          </div>
        </div>`;
    });
  }

  function buildMap(list){
    const map={};
    list.forEach(e=>{
      if(!map[e.titulo]) map[e.titulo]={users:new Set(),mid:new Set(),finish:new Set()};
      map[e.titulo].users.add(e.user_id);
      if(e.progress_percent>=50) map[e.titulo].mid.add(e.user_id);
      if(e.progress_percent>=95) map[e.titulo].finish.add(e.user_id);
    });
    return Object.fromEntries(
      Object.entries(map).map(([k,v])=>[
        k,{
          total:v.users.size,
          mid:Math.round(v.mid.size/v.users.size*100)||0,
          finish:Math.round(v.finish.size/v.users.size*100)||0
        }
      ]).sort((a,b)=>b[1].total-a[1].total)
    );
  }

  renderTop(topDia, buildMap(events));

  const limite = new Date(Date.now()-30*60000).toISOString();
  renderTop(topAgora, buildMap(events.filter(e=>e.created_at>=limite)));

  /* CHARTS */
  const horas={};
  events.forEach(e=>{
    const h=new Date(e.created_at).getHours();
    horas[h]=(horas[h]||0)+1;
  });

  if(chartHoras) chartHoras.destroy();
  chartHoras=new Chart(chartHorasCtx,{
    type:"line",
    data:{labels:Object.keys(horas),datasets:[{data:Object.values(horas),borderColor:"#e50914"}]}
  });

  const filmesCount=events.filter(e=>e.tipo==="filme").length;
  const seriesCount=events.filter(e=>e.tipo==="serie").length;

  if(chartTipos) chartTipos.destroy();
  chartTipos=new Chart(chartTiposCtx,{
    type:"doughnut",
    data:{labels:["Filmes","SÃ©ries"],datasets:[{data:[filmesCount,seriesCount],backgroundColor:["#e50914","#6366f1"]}]}
  });
}

const chartHorasCtx=document.getElementById("chartHoras");
const chartTiposCtx=document.getElementById("chartTipos");

dataFiltro.onchange=loadDashboard;
loadDashboard();
setInterval(loadDashboard,15000);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard â€¢ SessÃ£o 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f0f10;
  --card:#1b1b1e;
  --accent:#e50914;
  --text:#fff;
  --muted:#aaa;
  --green:#22c55e;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:20px 32px;
  background:#000;
  position:sticky;
  top:0;
  z-index:10;
}
header h1{margin:0;color:var(--accent)}

main{
  padding:32px;
  display:grid;
  gap:32px;
}

/* KPI */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}
.kpi{
  background:var(--card);
  padding:20px;
  border-radius:14px;
}
.kpi span{color:var(--muted);font-size:13px}
.kpi strong{font-size:34px;display:block;margin-top:6px}

/* ONLINE */
.online-list{
  display:grid;
  gap:10px;
}
.online-user{
  background:var(--card);
  padding:12px 16px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:var(--green);
}

/* GRID FILMES */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:18px;
}
.card{
  background:var(--card);
  border-radius:14px;
  overflow:hidden;
}
.card img{
  width:100%;
  height:260px;
  object-fit:cover;
}
.card-info{
  padding:12px;
}
.card-info strong{display:block}
.card-info span{font-size:12px;color:var(--muted)}
.badge{margin-top:6px;font-size:12px}

/* SECTIONS */
.section h2{margin:0 0 14px;font-size:20px}
canvas{background:var(--card);border-radius:14px;padding:10px}
</style>
</head>

<body>

<header>
  <h1>ğŸ“Š Dashboard â€¢ SessÃ£o 99</h1>
</header>

<main>

<!-- KPIS -->
<div class="kpis">
  <div class="kpi"><span>ğŸ‘€ Online agora</span><strong id="kpiOnline">0</strong></div>
  <div class="kpi"><span>â–¶ Hoje</span><strong id="kpiHoje">0</strong></div>
  <div class="kpi"><span>ğŸ“… Semana</span><strong id="kpiSemana">0</strong></div>
</div>

<!-- ONLINE -->
<div class="section">
  <h2>ğŸŸ¢ UsuÃ¡rios online</h2>
  <div class="online-list" id="listaOnline"></div>
</div>

<!-- GRÃFICO -->
<div class="section">
  <h2>ğŸ“ˆ Pico simultÃ¢neo</h2>
  <canvas id="chartOnline" height="120"></canvas>
</div>

<!-- TOPS -->
<div class="section">
  <h2>ğŸ”¥ Mais assistidos agora (30 min)</h2>
  <div class="grid" id="topAgora"></div>
</div>

<div class="section">
  <h2>ğŸ† Top do dia</h2>
  <div class="grid" id="topDia"></div>
</div>

<div class="section">
  <h2>ğŸ“… Top da semana</h2>
  <div class="grid" id="topSemana"></div>
</div>

</main>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

let chart, historico=[];

/* DASHBOARD */
async function loadDashboard(){
  const agora = new Date();
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const semana = new Date(); semana.setDate(semana.getDate()-7);

  /* ONLINE */
  const { data: online } = await sb
    .from("assistindo_agora")
    .select("usuario_id, filme_id, last_ping")
    .gte("last_ping", new Date(Date.now()-30000).toISOString());

  kpiOnline.textContent = online.length;
  listaOnline.innerHTML="";
  online.forEach(u=>{
    listaOnline.innerHTML+=`
      <div class="online-user">
        <div>${u.usuario_id.slice(0,8)}...</div>
        <div class="dot"></div>
      </div>
    `;
  });

  /* ALERTA */
  if(online.length >= 5){
    console.log("ğŸ”¥ ALERTA: muitos usuÃ¡rios online!");
  }

  /* HISTÃ“RICO ONLINE */
  historico.push({ t:new Date().toLocaleTimeString(), v:online.length });
  if(historico.length>20) historico.shift();
  renderChart();

  /* VISUALIZAÃ‡Ã•ES */
  const { data: vis } = await sb
    .from("visualizacoes")
    .select("filme_id, created_at");

  kpiHoje.textContent = vis.filter(v=>new Date(v.created_at)>=hoje).length;
  kpiSemana.textContent = vis.filter(v=>new Date(v.created_at)>=semana).length;

  /* FILMES */
  const { data: filmes } = await sb.from("filmes").select("*");

  function buildTop(lista){
    const map={};
    lista.forEach(v=>map[v.filme_id]=(map[v.filme_id]||0)+1);
    return Object.entries(map)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([id,total])=>{
        const f=filmes.find(x=>x.id===id);
        return f?{...f,total}:null;
      }).filter(Boolean);
  }

  render(topAgora, buildTop(vis.filter(v=>new Date(v.created_at)>=new Date(Date.now()-30*60000))));
  render(topDia, buildTop(vis.filter(v=>new Date(v.created_at)>=hoje)));
  render(topSemana, buildTop(vis.filter(v=>new Date(v.created_at)>=semana)));
}

/* RENDER */
function render(container,list){
  container.innerHTML="";
  list.forEach(f=>{
    container.innerHTML+=`
      <div class="card">
        <img src="${f.capa_url}">
        <div class="card-info">
          <strong>${f.titulo||f.serie_nome}</strong>
          <span>${f.genero} â€¢ ${f.tipo}</span>
          <div class="badge">ğŸ‘ ${f.total}</div>
        </div>
      </div>`;
  });
}

/* CHART */
function renderChart(){
  if(chart) chart.destroy();
  chart = new Chart(chartOnline,{
    type:"line",
    data:{
      labels:historico.map(h=>h.t),
      datasets:[{data:historico.map(h=>h.v),borderColor:"#e50914",tension:.3}]
    },
    options:{plugins:{legend:{display:false}}}
  });
}

/* REALTIME */
sb.channel("realtime-dashboard")
  .on("postgres_changes",{event:"*",schema:"public",table:"assistindo_agora"},loadDashboard)
  .on("postgres_changes",{event:"*",schema:"public",table:"visualizacoes"},loadDashboard)
  .subscribe();

loadDashboard();
</script>

</body>
</html>

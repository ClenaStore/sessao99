<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SESS√ÉO 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#05070f;
  --panel:#0b1020;
  --card:#141a2e;
  --accent:#e50914;
  --text:#ffffff;
  --muted:#9ca3af;
  --radius:14px;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 50% -200px, #11183a, transparent),
    var(--bg);
  color:var(--text);
  font-family:Inter,Arial,sans-serif;
}
header{
  position:sticky;
  top:0;
  z-index:100;
  padding:16px 32px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(5,7,15,.75);
  backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.05);
}
header h1{color:var(--accent);margin:0;font-size:22px}
header input{
  background:#0f1326;
  border:1px solid rgba(255,255,255,.08);
  border-radius:999px;
  padding:10px 16px;
  color:#fff;
  width:280px;
}
section{padding:24px 32px}
.row{display:flex;gap:16px;overflow-x:auto}
.card{
  min-width:180px;
  border-radius:14px;
  overflow:hidden;
  cursor:pointer;
  background:#141a2e;
}
.card img{width:100%;height:260px;object-fit:cover}
.card span{position:absolute;bottom:12px;left:12px;font-weight:600}
#player{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  flex-direction:column;
  z-index:9999;
}
.top{padding:14px 20px;display:flex;gap:14px}
.cover{width:100%;max-height:420px;object-fit:cover}
.selects{display:flex;gap:12px;padding:14px 20px}
video{width:100%;height:calc(100vh - 320px)}
</style>
</head>

<body>

<header>
  <h1>SESS√ÉO 99</h1>
  <input id="search" placeholder="Buscar filmes ou s√©ries...">
</header>

<div id="home"></div>

<div id="player">
  <div class="top">
    <button onclick="fechar()">‚¨Ö Voltar</button>
    <strong id="tituloPlayer"></strong>
  </div>
  <img id="capaPlayer" class="cover">
  <div class="selects">
    <select id="selTemporada"></select>
    <select id="selEpisodio"></select>
  </div>
  <video id="video" controls></video>
</div>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ================= USER ================= */
const USER_ID = localStorage.user_id || crypto.randomUUID();
localStorage.user_id = USER_ID;

/* ================= ELEMENTOS ================= */
const home = document.getElementById("home");
const search = document.getElementById("search");
const player = document.getElementById("player");
const tituloPlayer = document.getElementById("tituloPlayer");
const capaPlayer = document.getElementById("capaPlayer");
const selTemporada = document.getElementById("selTemporada");
const selEpisodio = document.getElementById("selEpisodio");
const video = document.getElementById("video");

/* ================= STATE ================= */
let dados = [];
let serieAtual = [];
let episodioAtual = null;
let pingTimer = null;
let isPlaying = false;
let lastContentId = null;

/* ================= TRACKING ================= */
async function registrar(acao){
  if(!episodioAtual || !video.duration || isNaN(video.duration)) return;

  const played = Math.floor(video.currentTime);
  const duration = Math.floor(video.duration);
  const percent = Math.round((played / duration) * 100);
  const remaining = Math.max(duration - played, 0);
  const now = new Date().toISOString();

  await supabaseClient.from("rs_play_events").insert({
    user_id: USER_ID,
    content_id: episodioAtual.id,
    acao,
    tipo: episodioAtual.tipo,
    titulo: episodioAtual.titulo,
    serie_nome: episodioAtual.serie_nome,
    played_seconds: played,
    duration_seconds: duration,
    progress_percent: percent,
    created_at: now
  });

  await supabaseClient.rpc("rs_update_progress", {
    p_user_id: USER_ID,
    p_content_id: episodioAtual.id,
    p_titulo: episodioAtual.titulo,
    p_tipo: episodioAtual.tipo,
    p_progress: percent,
    p_remaining: remaining
  });

  if(acao === "play" || acao === "ping"){
    await supabaseClient.from("rs_sessions").upsert({
      user_id: USER_ID,
      content_id: episodioAtual.id,
      content_tipo: episodioAtual.tipo,
      serie_nome: episodioAtual.serie_nome,
      last_ping: now
    });
  }

  if(acao === "stop"){
    await supabaseClient.from("rs_sessions")
      .delete()
      .eq("user_id", USER_ID);
  }
}

/* ================= LOAD ================= */
async function load(){
  const { data } = await supabaseClient
    .from("filmes")
    .select("*")
    .eq("ativo", true);

  dados = data || [];
  renderHome(dados);
}

/* ================= HOME ================= */
function renderHome(list){
  home.innerHTML = "";
  const filmes = list.filter(i => i.tipo === "filme");
  const series = [...new Map(
    list.filter(i => i.tipo === "serie").map(s => [s.serie_nome, s])
  ).values()];
  renderRow("üé¨ Filmes", filmes, playFilme);
  renderRow("üì∫ S√©ries", series, s => abrirSerie(s.serie_nome));
}

function renderRow(titulo, itens, click){
  if(!itens.length) return;
  const sec = document.createElement("section");
  sec.innerHTML = `<h2>${titulo}</h2>`;
  const row = document.createElement("div");
  row.className = "row";
  itens.forEach(i=>{
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `<img src="${i.capa_url}"><span>${i.titulo||i.serie_nome}</span>`;
    c.onclick = () => click(i);
    row.appendChild(c);
  });
  sec.appendChild(row);
  home.appendChild(sec);
}

/* ================= PLAYER ================= */
function playFilme(f){
  serieAtual=[f];
  abrirPlayer(f.titulo,f.capa_url);
  tocar(f);
}

function abrirSerie(nome){
  serieAtual=dados.filter(d=>d.serie_nome===nome)
    .sort((a,b)=>a.temporada-b.temporada||a.episodio-b.episodio);
  abrirPlayer(nome,serieAtual[0].capa_url);
  montarTemporadas();
}

function abrirPlayer(titulo,capa){
  tituloPlayer.textContent=titulo;
  capaPlayer.src=capa;
  player.style.display="flex";
}

function montarTemporadas(){
  const temps=[...new Set(serieAtual.map(e=>e.temporada))];
  selTemporada.innerHTML="";
  temps.forEach(t=>selTemporada.innerHTML+=`<option value="${t}">Temporada ${t}</option>`);
  selTemporada.onchange=montarEpisodios;
  montarEpisodios();
}

function montarEpisodios(){
  const t=Number(selTemporada.value);
  const eps=serieAtual.filter(e=>e.temporada===t);
  selEpisodio.innerHTML="";
  eps.forEach((e,i)=>selEpisodio.innerHTML+=`<option value="${i}">Epis√≥dio ${e.episodio}</option>`);
  selEpisodio.onchange=()=>tocar(eps[selEpisodio.value]);
  tocar(eps[0]);
}

function tocar(ep){
  if(lastContentId && lastContentId!==ep.id) registrar("stop");
  episodioAtual=ep;
  lastContentId=ep.id;
  clearInterval(pingTimer);
  isPlaying=false;
  video.src=ep.video_url;
  video.load();
}

/* ================= EVENTS ================= */
video.addEventListener("loadedmetadata",()=>video.play());

video.addEventListener("play",async()=>{
  if(isPlaying) return;
  isPlaying=true;
  await registrar("play");
  pingTimer=setInterval(()=>registrar("ping"),15000);
});

video.addEventListener("pause",()=>{
  isPlaying=false;
  clearInterval(pingTimer);
  registrar("pause");
});

function fechar(){
  isPlaying=false;
  clearInterval(pingTimer);
  registrar("stop");
  video.pause();
  video.src="";
  player.style.display="none";
}

window.addEventListener("beforeunload",()=>registrar("stop"));

search.oninput=()=>{
  const v=search.value.toLowerCase();
  renderHome(dados.filter(d =>
    d.titulo?.toLowerCase().includes(v) ||
    d.serie_nome?.toLowerCase().includes(v)
  ));
};

load();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SESS√ÉO 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#05070f;
  --panel:#0b1020;
  --card:#141a2e;
  --accent:#e50914;
  --text:#fff;
  --muted:#9ca3af;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial}

/* HEADER */
header{
  padding:18px 32px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h1{color:var(--accent);margin:0}
header input{
  background:#111;border:none;border-radius:8px;
  padding:10px 14px;color:#fff;width:260px
}

/* HOME */
section{padding:0 32px 32px}
.row{
  display:flex;
  gap:14px;
  overflow-x:auto;
}
.row::-webkit-scrollbar{display:none}
.card{
  min-width:180px;
  cursor:pointer;
  transition:.25s;
}
.card:hover{transform:scale(1.08)}
.card img{
  width:100%;
  height:260px;
  object-fit:cover;
  border-radius:10px;
}

/* S√âRIE PAGE */
#seriePage,#playerPage{
  position:fixed;inset:0;
  background:#000;
  display:none;
  flex-direction:column;
  z-index:9999;
}
.top{
  padding:12px 18px;
  display:flex;
  align-items:center;
  gap:12px;
}
.top button{
  background:#111;border:none;color:#fff;
  padding:8px 14px;border-radius:8px;cursor:pointer
}
.cover{
  width:100%;
  max-height:420px;
  object-fit:cover;
}
.selects{
  display:flex;
  gap:12px;
  padding:12px 18px;
}
select{
  background:#111;border:none;color:#fff;
  padding:10px;border-radius:8px
}
video{
  width:100%;
  height:calc(100vh - 220px);
  background:#000
}
</style>
</head>
<body>

<header>
  <h1>SESS√ÉO 99</h1>
  <input id="search" placeholder="Buscar...">
</header>

<div id="home"></div>

<!-- P√ÅGINA DA S√âRIE -->
<div id="seriePage">
  <div class="top">
    <button onclick="fecharSerie()">‚¨Ö Voltar</button>
    <strong id="serieTitulo"></strong>
  </div>
  <img id="serieCapa" class="cover">
  <div class="selects">
    <select id="selTemporada"></select>
    <select id="selEpisodio"></select>
  </div>
  <video id="video" controls autoplay></video>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const home=document.getElementById("home");
const search=document.getElementById("search");

const seriePage=document.getElementById("seriePage");
const serieTitulo=document.getElementById("serieTitulo");
const serieCapa=document.getElementById("serieCapa");
const selTemporada=document.getElementById("selTemporada");
const selEpisodio=document.getElementById("selEpisodio");
const video=document.getElementById("video");

let dados=[], serieAtual=[], episodioAtual=null;

/* LOAD */
async function load(){
  const { data } = await supabaseClient
    .from("filmes")
    .select("*")
    .eq("ativo",true);

  dados=data||[];
  renderHome(dados);
}

/* HOME */
function renderHome(list){
  home.innerHTML="";

  const filmes=list.filter(i=>i.tipo==="filme");
  const series=[...new Map(
    list.filter(i=>i.tipo==="serie")
      .map(s=>[s.serie_nome,s])
  ).values()];

  renderRow("üé¨ Filmes",filmes,f=>playFilme(f));
  renderRow("üì∫ S√©ries",series,s=>abrirSerie(s.serie_nome));
}

function renderRow(titulo,itens,click){
  if(!itens.length)return;
  const sec=document.createElement("section");
  sec.innerHTML=`<h2>${titulo}</h2>`;
  const row=document.createElement("div");
  row.className="row";

  itens.forEach(i=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<img src="${i.capa_url}">`;
    c.onclick=()=>click(i);
    row.appendChild(c);
  });

  sec.appendChild(row);
  home.appendChild(sec);
}

/* FILME */
function playFilme(f){
  abrirSeriePlayer([f],f);
}

/* ABRIR S√âRIE */
function abrirSerie(nome){
  serieAtual=dados
    .filter(d=>d.serie_nome===nome)
    .sort((a,b)=>a.temporada-b.temporada||a.episodio-b.episodio);

  serieTitulo.textContent=nome;
  serieCapa.src=serieAtual[0].capa_url;
  montarTemporadas();
  seriePage.style.display="flex";
}

/* TEMPORADAS */
function montarTemporadas(){
  const temps=[...new Set(serieAtual.map(e=>e.temporada))];
  selTemporada.innerHTML="";
  temps.forEach(t=>{
    selTemporada.innerHTML+=`<option value="${t}">Temporada ${t}</option>`;
  });
  selTemporada.onchange=montarEpisodios;
  montarEpisodios();
}

/* EPIS√ìDIOS */
function montarEpisodios(){
  const t=Number(selTemporada.value);
  const eps=serieAtual.filter(e=>e.temporada===t);
  selEpisodio.innerHTML="";
  eps.forEach((e,i)=>{
    selEpisodio.innerHTML+=`<option value="${i}">Epis√≥dio ${e.episodio}</option>`;
  });
  selEpisodio.onchange=()=>{
    tocar(eps[selEpisodio.value]);
  };
  tocar(eps[0]);
}

/* TOCAR */
function tocar(ep){
  episodioAtual=ep;
  video.src=ep.video_url;
}

/* AUTO NEXT */
video.onended=()=>{
  const idx=serieAtual.findIndex(e=>e.id===episodioAtual.id);
  if(serieAtual[idx+1]){
    tocar(serieAtual[idx+1]);
  }
};

/* FECHAR */
function fecharSerie(){
  video.pause();
  seriePage.style.display="none";
}

/* BUSCA */
search.oninput=()=>{
  const v=search.value.toLowerCase();
  renderHome(dados.filter(d=>d.titulo.toLowerCase().includes(v)));
};

load();
</script>

</body>
</html>

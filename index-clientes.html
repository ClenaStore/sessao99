<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SESSÃO 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#05070f;
  --card:#141a2e;
  --accent:#e50914;
  --text:#ffffff;
  --muted:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,Arial,sans-serif;
}

/* HEADER */
header{
  padding:16px 32px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h1{
  margin:0;
  color:var(--accent);
}
header input{
  background:#111;
  border:none;
  border-radius:8px;
  padding:10px 14px;
  color:#fff;
  width:260px;
}

/* SEÇÕES */
section{padding:16px 32px}
section h2{margin:0 0 12px}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:16px;
}
.card{
  cursor:pointer;
  transition:.2s;
}
.card:hover{transform:scale(1.06)}
.card img{
  width:100%;
  height:260px;
  object-fit:cover;
  border-radius:8px;
}

/* DETALHE */
#detalhe{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  flex-direction:column;
  z-index:9999;
}
#detalhe header{
  background:#000;
}
#detalhe main{
  padding:24px 32px;
  max-width:1100px;
}
#detalhe video{
  width:100%;
  max-height:70vh;
  border-radius:12px;
}
.btn{
  margin-top:14px;
  background:var(--accent);
  border:none;
  padding:12px 18px;
  color:#fff;
  border-radius:8px;
  cursor:pointer;
}
.episodios{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:12px;
  margin-top:16px;
}
.ep{
  background:#141414;
  padding:10px;
  border-radius:8px;
  cursor:pointer;
}
.ep:hover{background:#1f1f1f}
.small{color:var(--muted);font-size:13px}
</style>
</head>
<body>

<header>
  <h1>SESSÃO 99</h1>
  <input id="search" placeholder="Buscar...">
</header>

<section>
  <h2>Todos os títulos</h2>
  <div class="grid" id="grid"></div>
</section>

<!-- DETALHE -->
<div id="detalhe">
  <header>
    <button class="btn" onclick="fechar()">⬅ Voltar</button>
  </header>
  <main>
    <h2 id="dTitulo"></h2>
    <p id="dDesc" class="small"></p>
    <video id="player" controls autoplay></video>
    <div id="episodios"></div>
  </main>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const grid=document.getElementById("grid");
const search=document.getElementById("search");
const detalhe=document.getElementById("detalhe");
const player=document.getElementById("player");
const dTitulo=document.getElementById("dTitulo");
const dDesc=document.getElementById("dDesc");
const episodiosDiv=document.getElementById("episodios");

let dados=[];

/* LOAD */
async function carregar(){
  const { data } = await supabaseClient
    .from("filmes")
    .select("*")
    .eq("ativo",true)
    .order("created_at",{ascending:false});

  dados=data||[];
  render(dados);
}

/* GRID */
function render(lista){
  grid.innerHTML="";
  lista.forEach(f=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`<img src="${f.capa_url}">`;
    d.onclick=()=>abrir(f);
    grid.appendChild(d);
  });
}

/* ABRIR */
function abrir(item){
  detalhe.style.display="flex";
  dTitulo.textContent=item.titulo;
  dDesc.textContent=item.descricao||"";

  if(item.tipo==="serie"){
    carregarSerie(item.serie_nome,item.temporada,item.episodio);
  }else{
    episodiosDiv.innerHTML="";
    player.src=item.video_url;
  }
}

/* SÉRIES */
function carregarSerie(nome){
  const eps=dados
    .filter(d=>d.tipo==="serie" && d.serie_nome===nome)
    .sort((a,b)=>a.temporada-b.temporada||a.episodio-b.episodio);

  dTitulo.textContent=nome;
  dDesc.textContent="Série";

  episodiosDiv.innerHTML=`<h3>Episódios</h3><div class="episodios"></div>`;
  const gridEp=episodiosDiv.querySelector(".episodios");

  eps.forEach(ep=>{
    const e=document.createElement("div");
    e.className="ep";
    e.innerHTML=`<strong>S${ep.temporada}E${ep.episodio}</strong><br><span class="small">${ep.titulo}</span>`;
    e.onclick=()=>{
      player.src=ep.video_url;
      player.play();
    };
    gridEp.appendChild(e);
  });

  player.src=eps[0].video_url;
}

/* FECHAR */
function fechar(){
  player.pause();
  player.src="";
  detalhe.style.display="none";
}

/* BUSCA */
search.oninput=()=>{
  const v=search.value.toLowerCase();
  render(dados.filter(d=>d.titulo.toLowerCase().includes(v)));
};

carregar();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SESSÃO 99</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#05070f;
  --panel:#0b1020;
  --card:#141a2e;
  --accent:#e50914;
  --text:#fff;
  --muted:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,Arial,sans-serif;
}
header{
  padding:18px 32px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h1{color:var(--accent);margin:0}
header input{
  background:#111;
  border:none;
  border-radius:8px;
  padding:10px 14px;
  color:#fff;
  width:260px;
}
section{padding:0 32px 32px}
.row{
  display:flex;
  gap:14px;
  overflow-x:auto;
}
.card{
  min-width:180px;
  cursor:pointer;
  transition:.25s;
}
.card:hover{transform:scale(1.08)}
.card img{
  width:100%;
  height:260px;
  object-fit:cover;
  border-radius:10px;
}

/* PLAYER */
#player{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  flex-direction:column;
  z-index:9999;
}
.top{
  padding:14px 18px;
  display:flex;
  align-items:center;
  gap:12px;
}
.top button{
  background:#111;
  border:none;
  color:#fff;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}
.cover{
  width:100%;
  max-height:420px;
  object-fit:cover;
}
.selects{
  display:flex;
  gap:12px;
  padding:12px 18px;
}
select{
  background:#111;
  border:none;
  color:#fff;
  padding:10px;
  border-radius:8px;
}
video{
  width:100%;
  height:calc(100vh - 280px);
  background:#000;
}
</style>
</head>

<body>

<header>
  <h1>SESSÃO 99</h1>
  <input id="search" placeholder="Buscar...">
</header>

<div id="home"></div>

<div id="player">
  <div class="top">
    <button onclick="fechar()">⬅ Voltar</button>
    <strong id="tituloPlayer"></strong>
  </div>
  <img id="capaPlayer" class="cover">
  <div class="selects">
    <select id="selTemporada"></select>
    <select id="selEpisodio"></select>
  </div>
  <video id="video" controls autoplay></video>
</div>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ================= USER ================= */
const USER_ID = localStorage.user_id || crypto.randomUUID();
localStorage.user_id = USER_ID;

/* ================= STATE ================= */
let episodioAtual = null;
let pingTimer = null;

/* ================= TRACKING ================= */
async function registrar(acao){
  if(!episodioAtual || !video.duration) return;

  const now = new Date().toISOString();
  const played = Math.floor(video.currentTime);
  const duration = Math.floor(video.duration);
  const percent = Math.round((played / duration) * 100);
  const remaining = Math.max(duration - played, 0);

  /* HISTÓRICO */
  await supabaseClient.from("rs_play_events").insert({
    user_id: USER_ID,
    content_id: episodioAtual.id,
    acao,
    tipo: episodioAtual.tipo,
    titulo: episodioAtual.titulo,
    serie_nome: episodioAtual.serie_nome,
    played_seconds: played,
    duration_seconds: duration,
    progress_percent: percent,
    created_at: now
  });

  /* PROGRESSO */
  await supabaseClient.from("rs_user_progress").upsert({
    user_id: USER_ID,
    content_id: episodioAtual.id,
    titulo: episodioAtual.titulo,
    tipo: episodioAtual.tipo,
    max_progress: percent,
    remaining_seconds: remaining,
    updated_at: now
  });

  /* SESSÃO */
  if(acao === "play" || acao === "ping"){
    await supabaseClient.from("rs_sessions").upsert({
      user_id: USER_ID,
      content_id: episodioAtual.id,
      content_tipo: episodioAtual.tipo,
      serie_nome: episodioAtual.serie_nome,
      temporada: episodioAtual.temporada || null,
      episodio: episodioAtual.episodio || null,
      started_at: now,
      last_ping: now,
      status: "playing",
      user_agent: navigator.userAgent
    });
  }

  if(acao === "pause"){
    await supabaseClient
      .from("rs_sessions")
      .update({ status: "paused", last_ping: now })
      .eq("user_id", USER_ID);
  }

  if(acao === "stop"){
    await supabaseClient
      .from("rs_sessions")
      .delete()
      .eq("user_id", USER_ID);
  }
}

/* ================= VIDEO EVENTS ================= */
video.addEventListener("play",()=>{
  registrar("play");
  pingTimer = setInterval(()=>registrar("ping"),15000);
});

video.addEventListener("pause",()=>{
  clearInterval(pingTimer);
  registrar("pause");
});

window.addEventListener("beforeunload",()=>{
  registrar("stop");
});

function fechar(){
  clearInterval(pingTimer);
  registrar("stop");
  video.pause();
  video.src = "";
  player.style.display = "none";
}
</script>


</body>
</html>
